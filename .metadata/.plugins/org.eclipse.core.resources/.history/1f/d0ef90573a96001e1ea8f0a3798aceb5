package data;
import java.sql.Connection;
import java.sql.Date;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Types;
import java.time.LocalDate;
import java.util.ArrayList;
import java.sql.PreparedStatement;
import bus.*;

public class CustomerDB {
	static private Connection myConnection;
	static private String mySQLStatement = null;	
	static private String mySQLQuery = null;
	
	public static void insert(Customer aNewCustomer) throws SQLException 
	{	 	
    	Integer id = UserDB.insert(aNewCustomer);
   
	    if (id != null) {
	        PreparedStatement myPreparedStatement = null ;
			String sqlStatement;
			
			sqlStatement = "insert into customerbank values(? , ? , ?)";
					
			myPreparedStatement = myConnection.prepareStatement(sqlStatement);		
			
			myPreparedStatement.setInt(1, id);
			myPreparedStatement.setDouble(2, aNewCustomer.getSalary());
			myPreparedStatement.setInt(3, aNewCustomer.getMgr());	// ALTERADO CLASSE PARA MANAGER SER INTEGER AO INVES DE OBJ
			
			myPreparedStatement.executeUpdate();	
			
			myConnection.commit();	
	    }
	}
	
	public static void update(Customer aChangedCustomer) throws SQLException {
		
		myConnection = DBConnection.getConnection();
		
		mySQLStatement = "update customerbank set salary = "    
			              +   aChangedCustomer.getSalary() + ", mgrid = " 
			              +   aChangedCustomer.getMgr() + " WHERE checkingaccountid = "
			              +   aChangedAccount.getAccountNumber();
	
		Statement myStatemnt = myConnection.createStatement();
		myStatemnt.executeUpdate(mySQLStatement);
		myConnection.commit();								
	}
	
	public static CheckingAccount search(Integer id) throws SQLException, ExceptionIsNull, ExceptionIsNotANumber, ExceptionIsPassedDate{
		
		CheckingAccount aCheckingAccount = null;
		
		myConnection = DBConnection.getConnection();
		
		mySQLQuery = "SELECT a.accountid, a.customerid, a.balance, a.openingdate, a.typeaccount, c.month_trans_limit, c.trans_fee"
					+ "FROM accountbank a "
					+ "JOIN checkingaccount c ON a.accountid = c.checkingaccountid "
					+ "WHERE a.accountid = " + id ;
		
		Statement myStatemnt = myConnection.createStatement();
		
		ResultSet myResultSet = myStatemnt.executeQuery(mySQLQuery);
		
		if(myResultSet.next()) {
			EnumTypeAccount type = EnumTypeAccount.valueOf(myResultSet.getString("typeaccount"));
            Integer customerid = myResultSet.getInt("customerid");		
            Double balance = myResultSet.getDouble("balance");
            LocalDate openingDate = myResultSet.getDate("openingdate").toLocalDate();
            Integer monthly_limit = myResultSet.getInt("month_trans_limit");
            Double transactionFees = myResultSet.getDouble("trans_fee");

            aCheckingAccount = new CheckingAccount(type, customerid, balance, openingDate, monthly_limit, transactionFees);
		}	
		
		return aCheckingAccount;
	}
	
	public static ArrayList<CheckingAccount> select() throws SQLException, ExceptionIsNull, ExceptionIsNotANumber{
		
		CheckingAccount aCheckingAccount = null;
		myConnection = DBConnection.getConnection();
		
		mySQLQuery = "SELECT a.accountid, a.customerid, a.balance, a.openingdate, a.typeaccount, c.month_trans_limit, c.trans_fee"
				+ "FROM accountbank a "
				+ "JOIN checkingaccount c ON a.accountid = c.checkingaccountid ";
		
		Statement myStatemnt = myConnection.createStatement();
		
		ResultSet myResultSet = myStatemnt.executeQuery(mySQLQuery);
		
		ArrayList<CheckingAccount> myList = new ArrayList<CheckingAccount>();
		
		while(myResultSet.next()) {
			EnumTypeAccount type = EnumTypeAccount.valueOf(myResultSet.getString("typeaccount"));
            Integer customerid = myResultSet.getInt("customerid");		
            Double balance = myResultSet.getDouble("balance");
            LocalDate openingDate = myResultSet.getDate("openingdate").toLocalDate();
            Integer monthly_limit = myResultSet.getInt("month_trans_limit");
            Double transactionFees = myResultSet.getDouble("trans_fee");

            aCheckingAccount = new CheckingAccount(type, customerid, balance, openingDate, monthly_limit, transactionFees);

			myList.add(aCheckingAccount);
		}
		
		return myList;
	}
}
